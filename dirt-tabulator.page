Menu="DiskUtilities"
Title="Deduplication in Real-Time"
Icon="fa-search-minus"
---
<link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
<link href="/plugins/bobbintb.system.dirt/nodejs/frontend/css/dirt-tabulator.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/dirt-tabulator-formatters.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/dirt-tabulator-helpers.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/left-table.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/right-table.js"></script>
<script src="https://unpkg.com/split.js/dist/split.min.js"></script>

<div class="table-container">
    <div id="left-table" class="table-wrapper"></div>
    <div id="right-table" class="table-wrapper"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let socket;

    Split(['#left-table', '#right-table'], {
        sizes: [70, 30],
        gutterSize: 8,
        cursor: 'col-resize'
    });

    const leftTable = new Tabulator("#left-table", {
        ...leftTableConfig,
        renderComplete: function(){
            var table = this;
            var element = table.element;
            var tableWidth = element.offsetWidth;
            var columns = table.getColumns();
            var columnsWidth = 0;
            columns.forEach(function(column){
                columnsWidth += column.getWidth();
            });

            if(tableWidth > columnsWidth){
                var pathColumn = table.getColumn("path");
                pathColumn.setWidth(pathColumn.getWidth() + (tableWidth - columnsWidth));
            }
        },
    });
    const rightTable = new Tabulator("#right-table", rightTableConfig);

    function connect() {
        socket = new WebSocket(`ws://${window.location.hostname}:41820?clientId=dirt-tabulator.page`);

        socket.onopen = function() {
            console.log("Tabulator Tab: WebSocket connection established.");
            dirtySock('findDuplicates', null);
        };

        socket.onmessage = function(event) {
            const parsedMessage = JSON.parse(event.data);
            const { action, data } = parsedMessage;

            if (action === 'duplicateFiles') {
                console.log("Tabulator Tab: Received duplicateFiles data package.");
                const { duplicates } = data;

                const tableData = [];
                duplicates.forEach(group => {
                    group.files.forEach(file => {
                        tableData.push({
                            ...file,
                            hash: group.hash,
                        });
                    });
                });

                leftTable.replaceData(tableData);
                rightTable.replaceData(tableData);
            } else if (action === 'addOrUpdateFile') {
                console.log(`Tabulator Tab: Received addOrUpdateFile for ino ${data.ino}`);
                leftTable.updateOrAddData([data]);
                rightTable.updateOrAddData([data]);
            } else if (action === 'removeFile') {
                console.log(`Tabulator Tab: Received removeFile for ino ${data.ino}`);
                leftTable.deleteRow(data.ino);
                rightTable.deleteRow(data.ino);
            }
        };

        socket.onclose = function(event) {
            console.log("Tabulator Tab: WebSocket connection closed. Reconnecting...");
            setTimeout(connect, 1000);
        };

        socket.onerror = function(error) {
            console.error("Tabulator Tab: WebSocket error: ", error);
            socket.close();
        };
    }

    function dirtySock(action, data) {
        const message = {
            clientId: "dirt-tabulator.page",
            action: action,
            data: data
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(message));
        } else {
            console.error("Tabulator Tab: WebSocket is not connected.");
        }
    }

    connect();
});
</script>
