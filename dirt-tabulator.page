Menu="dirtSettings:4"
Title="Tabulator"
---
<link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

<div id="duplicatesTable-tabulator"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let socket;
    let table;

    function connect() {
      socket = new WebSocket(`ws://${window.location.hostname}:41820?clientId=dirt-tabulator.page`);

      socket.onopen = function() {
        console.log("Tabulator Tab: WebSocket connection established.");
        dirtySock('findDuplicates', null);
      };

      socket.onmessage = function(event) {
        const parsedMessage = JSON.parse(event.data);
        const { action, data } = parsedMessage;

        if (action === 'duplicateFiles') {
          console.log("Tabulator Tab: Received duplicateFiles data.");

          // Tabulator's data tree requires the children array to be named '_children'
          const tableData = data.map(group => {
              return { ...group, _children: group.files };
          });

          table = new Tabulator("#duplicatesTable-tabulator", {
              data: tableData,
              layout: "fitColumns",
              dataTree: true,
              dataTreeStartExpanded: false,
              placeholder: "No duplicate files found",
              columns: [
                  { title: "Hash", field: "hash", width: 300 },
                  {
                      title: "File Count",
                      field: "files",
                      formatter: (cell, formatterParams, onRendered) => {
                          // This formatter only shows the count on the parent row
                          const rowData = cell.getRow().getData();
                          if (rowData._children && rowData._children.length > 0) {
                              return rowData._children.length;
                          }
                          return ""; // Hide for child rows
                      }
                  },
                  {
                      title: "Size",
                      field: "size",
                       formatter: (cell, formatterParams, onRendered) => {
                          const rowData = cell.getRow().getData();
                          // Show size for parent rows, hide for children
                          return rowData.hash ? rowData.size : "";
                       }
                  },
                  {
                      title: "Path",
                      field: "path",
                      formatter: (cell, formatterParams, onRendered) => {
                          const rowData = cell.getRow().getData();
                          // Only show the path for child rows
                          return rowData.path || "";
                      }
                  },
                  {
                      title: "Modified",
                      field: "mtime",
                      formatter: (cell, formatterParams, onRendered) => {
                          const value = cell.getValue();
                          // Only format and show the date for child rows
                          return value ? new Date(value).toLocaleString() : '';
                      }
                  }
              ],
          });
        }
      };

      socket.onclose = function(event) {
        console.log("Tabulator Tab: WebSocket connection closed. Reconnecting...");
        setTimeout(connect, 1000);
      };

      socket.onerror = function(error) {
        console.error("Tabulator Tab: WebSocket error: ", error);
        socket.close();
      };
    }

    function dirtySock(action, data) {
        const message = {
          clientId: "dirt-tabulator.page",
          action: action,
          data: data
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(message));
        } else {
          console.error("Tabulator Tab: WebSocket is not connected.");
        }
    }

    connect();
});
</script>
