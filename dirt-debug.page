Menu="dirtSettings:2"
Title="Debug"
---
<div id="debug-content">
    <h2>Debug Queries</h2>
    <p>Run manual queries against the Redis database for debugging purposes. Results will be logged to the browser's developer console and the Node.js console.</p>

    <hr>

    <div>
        <h4>Find File by Exact Path</h4>
        <input type="text" id="path-input" placeholder="Enter exact file path" style="width: 300px;">
        <button id="by-path-btn">Run Query</button>
    </div>

    <hr>

    <div>
        <h4>Find Files by Size</h4>
        <input type="number" id="size-input" placeholder="Enter file size in bytes">
        <button id="by-size-btn">Run Query</button>
    </div>

    <hr>

    <div>
        <h4>Find Files with Multiple Paths (Hard Links)</h4>
        <button id="multiple-paths-btn">Run Query</button>
    </div>

    <hr>

    <div>
        <h4>Find Files with Non-Unique Hashes (Duplicates)</h4>
        <button id="non-unique-hash-btn">Run Query</button>
    </div>

    <hr>

    <div>
        <h4>Save Database Snapshot</h4>
        <p>Triggers a background save of the Redis database and copies the snapshot to the plugin directory.</p>
        <button id="save-db-snapshot-btn">Save DB Snapshot</button>
    </div>

    <hr>

    <div>
        <h4>Create New File and Trigger Upsert</h4>
        <p>Creates a file of a specified size with random data at the given path, then queues a <code>file.upsert</code> job for it.</p>
        <input type="text" id="create-path-input" placeholder="Enter full file path" style="width: 300px;">
        <input type="number" id="create-size-input" placeholder="Enter size in bytes">
        <button id="create-file-btn">Create and Upsert</button>
    </div>

    <hr>

    <div>
        <h4>Trigger Upsert for Existing File</h4>
        <p>Queues a <code>file.upsert</code> job for an existing file path. Does not verify if the file exists.</p>
        <input type="text" id="upsert-path-input" placeholder="Enter full file path" style="width: 300px;">
        <button id="upsert-file-btn">Upsert File</button>
    </div>
</div>

<script>
$(function() {
    let socket;

    function connect() {
      socket = new WebSocket(`ws://<?= $_SERVER["SERVER_ADDR"] ?>:41820?clientId=dirt-debug.page`);

      socket.onopen = function() {
        console.log("Debug Tab: WebSocket connection established.");
      };

      socket.onmessage = function(event) {
        console.log("Debug Tab: Message from server: ", event.data);
      };

      socket.onclose = function(event) {
        console.log("Debug Tab: WebSocket connection closed. Reconnecting in 1 second...");
        setTimeout(connect, 1000);
      };

      socket.onerror = function(error) {
        console.error("Debug Tab: WebSocket error: ", error);
        socket.close();
      };
    }

    function dirtySock(action, data) {
        const message = {
          clientId: "dirt-debug.page",
          action: action,
          data: data
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(message));
          console.log(`Debug Tab: Sent action '${action}' with data:`, data);
        } else {
          console.error("Debug Tab: WebSocket is not connected. Message not sent:", message);
        }
    }

    // Connect on page load
    connect();

    // --- Event Listeners ---
    $('#by-size-btn').on('click', function() {
        const size = $('#size-input').val();
        if (size && !isNaN(size)) {
            dirtySock('debugFindFilesBySize', parseInt(size, 10));
        } else {
            console.error("Invalid size input. Please enter a number.");
        }
    });

    $('#by-path-btn').on('click', function() {
        const path = $('#path-input').val();
        if (path) {
            dirtySock('debugFindFileByPath', path);
        } else {
            console.error("Invalid path input. Please enter a path.");
        }
    });

    $('#multiple-paths-btn').on('click', function() {
        dirtySock('debugFindFilesWithMultiplePaths', null);
    });

    $('#non-unique-hash-btn').on('click', function() {
        dirtySock('debugFindFilesWithNonUniqueHashes', null);
    });

    $('#save-db-snapshot-btn').on('click', function() {
        dirtySock('saveDbSnapshot', null);
    });

    $('#create-file-btn').on('click', function() {
        const path = $('#create-path-input').val();
        const size = $('#create-size-input').val();
        if (path && size && !isNaN(size)) {
            dirtySock('debugCreateFileAndUpsert', { path: path, size: parseInt(size, 10) });
        } else {
            console.error("Invalid input. Please provide a valid path and numeric size.");
        }
    });

    $('#upsert-file-btn').on('click', function() {
        const path = $('#upsert-path-input').val();
        if (path) {
            dirtySock('debugUpsertExistingFile', { path: path });
        } else {
            console.error("Invalid input. Please provide a valid path.");
        }
    });
});
</script>